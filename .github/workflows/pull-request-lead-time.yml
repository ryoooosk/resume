name: Pull Request Lead Time
# Four keys metricsの変更のリードタイムに基づき、PRのファーストコミットからマージまでの時間を計測する。

on:
  pull_request:
    branches:
      - main
    types:
      - closed

permissions:
  pull-requests: write
  contents: read
  
jobs:
  pr-lead-time:
    if: github.event.pull_request.merged == true
    name: Calculate Lead Time
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Calculate Lead Time
        id: lead-time
        env:
          REPO: ${{ github.repository }}
        run: |
          # PR情報の取得
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # PRの基本情報を取得
          PR_INFO=$(gh api repos/"${REPO}"/pulls/"${PR_NUMBER}")

          # コミット情報を取得
          COMMITS_INFO=$(gh api repos/"${REPO}"/pulls/"${PR_NUMBER}"/commits)

          # レビュー情報を取得
          REVIEWS_INFO=$(gh api repos/"${REPO}"/pulls/"${PR_NUMBER}"/reviews)

          # 最初のコミット日時を取得
          FIRST_COMMITTED_AT=$(echo "${COMMITS_INFO}" | jq -r '.[0].commit.author.date')

          # 最初のレビュー日時を取得（レビューがない場合はnull）
          FIRST_REVIEWED_AT=$(echo "${REVIEWS_INFO}" | jq -r 'if length > 0 then .[0].submitted_at else null end')

          # マージ日時を取得
          MERGED_AT=$(echo "${PR_INFO}" | jq -r '.merged_at')

          # JSONデータを作成
          LEAD_TIME_JSON=$(echo "${PR_INFO}" | jq -c \
            --arg first_commit "${FIRST_COMMITTED_AT}" \
            --arg first_review "${FIRST_REVIEWED_AT}" \
            '{
                repository: .base.repo.name,
                title: .title,
                user: .user.login,
                url: .html_url,
                base: .base.ref,
                head: .head.ref,
                firstCommittedAt: $first_commit,
                createdAt: .created_at,
                firstReviewedAt: $first_review,
                mergedAt: .merged_at,
                additions: .additions,
                deletions: .deletions
            }')

          echo "result=${LEAD_TIME_JSON}" >> "${GITHUB_OUTPUT}"

          # 差分（秒）を計算して出力
          LEAD_TIME_SEC=$(( $(date -d "${MERGED_AT}" +%s) - $(date -d "${FIRST_COMMITTED_AT}" +%s) ))

          # 時間・分・秒に分解
          LEAD_TIME_H=$((LEAD_TIME_SEC / 3600))
          LEAD_TIME_M=$(((LEAD_TIME_SEC % 3600) / 60))
          LEAD_TIME_S=$((LEAD_TIME_SEC % 60))

          LEAD_TIME_FORMATTED="${LEAD_TIME_H}時間${LEAD_TIME_M}分${LEAD_TIME_S}秒"
          echo "lead_time_formatted=${LEAD_TIME_FORMATTED}" >> "${GITHUB_OUTPUT}"
      - name: Output Lead Time
        run: |
          echo 'Lead Time: ${{ steps.lead-time.outputs.result }}'
          echo 'Lead Time: ${{ steps.lead-time.outputs.lead_time_formatted }}'
      - name: Comment to PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "リードタイム: ${{ steps.lead-time.outputs.lead_time_formatted }}"
